---
layout: post
title: "bugs-2023"
date: 2021-02-01
categories: bug
---

---

## 问题:

新区某跨服活动未能正常开启

## 原因:

运营后台配分组时，使用日期作为分组 id，导致后面计算溢出 32 整数，导致逻辑错误

## 怎么发现的:

新区玩家反馈某跨服活动进入异常，
查模块数据未发现异常，review 业务流程，发现在一个判定是否有红蓝分组的方法返回结果异常
点进去看到代码`gid*10+1 ...`,结合 gid 为日期，确定为计算溢出问题

## 修复:

- 将数值类型改为 64 位
- 运营将分组 id 改为短 id

## 教训:

1. 对于有固定范围数值，应该对输入进行验证，提供给人使用的功能应该有友好提示
2. 计算过程注意数值溢出情况

---

## 问题:

某功能按不同区保存要处理的玩家 id，实际运行过程日志输出集合元素数量不符合预期

## 原因:

集合 key 使用 const 定义，导致动态拼接区服 id 的代码未能生效

```c++
//GAME_NAME有动态拼接区id
const std::string RECENT_UP_UIDS(GAME_NAME + "S:RUPS");
```

## 怎么发现的:

测试运行日志输出数量不符合预期，增加的 key 打印，发现 key 不对，所以区都写入一个 key 中

## 修复:

去掉 const 定义

```c++
std::string RECENT_UP_UIDS;

//Init
RECENT_UP_UIDS = GAME_NAME + "S:RUPS";
```

## 教训:

1. const 好，但要注意是否真的是 const
2. 对于启动执行次数少的日志，记录详细一些，便于发现问题。

---
