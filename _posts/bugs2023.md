---
layout: post
title: "bugs-2023"
date: 2021-02-01
categories: bug
---

---

## 问题:

新区某跨服活动未能正常开启

## 原因:

运营后台配分组时，使用日期作为分组 id，导致后面计算溢出 32 整数，导致逻辑错误

## 怎么发现的:

新区玩家反馈某跨服活动进入异常，
查模块数据未发现异常，review 业务流程，发现在一个判定是否有红蓝分组的方法返回结果异常
点进去看到代码`gid*10+1 ...`,结合 gid 为日期，确定为计算溢出问题

## 修复:

- 将数值类型改为 64 位
- 运营将分组 id 改为短 id

## 教训:

1. 对于有固定范围数值，应该对输入进行验证，提供给人使用的功能应该有友好提示
2. 计算过程注意数值溢出情况

---

## 问题:

某功能按不同区保存要处理的玩家 id，实际运行过程日志输出集合元素数量不符合预期

## 原因:

集合 key 使用 const 定义，导致动态拼接区服 id 的代码未能生效

```c++
//GAME_NAME有动态拼接区id
const std::string RECENT_UP_UIDS(GAME_NAME + "S:RUPS");
```

## 怎么发现的:

测试运行日志输出数量不符合预期，增加的 key 打印，发现 key 不对，所以区都写入一个 key 中

## 修复:

去掉 const 定义

```c++
std::string RECENT_UP_UIDS;

//Init
RECENT_UP_UIDS = GAME_NAME + "S:RUPS";
```

## 教训:

1. const 好，但要注意是否真的是 const
2. 对于启动执行次数少的日志，记录详细一些，便于发现问题。

---

## 问题:

开发的补丁功能执行偶尔出错，有时崩溃，有时取到错误数据，有时读取 redis 是卡住(read)

## 原因:

补丁在系统初始化完成前就执行了，初始化在主线程使用 redis 连接进行处理，补丁触发用户线程处理
若使用到同一个 redis 连接，就造成多线程使用同一 redis 连接，造成未定义错误

## 怎么发现的:

补丁开发完成内网执行偶尔出错，错误无法定位(卡在或崩在逻辑不通的地方)，线上测试环境更容易出现问题

## 修复:

延迟补丁到系统初始化完成后执行(补丁线程 sleep 检查初始化完成标志)

## 教训:

1. 测试过程任何问题都不应该忽略，尝试复现问题
2. 对于错误点在不可理解的地方，考虑是内存错误和多线程竞争问题
3. 对于资源绑定线程的系统，要注意初始化完成前，资源的访问可能不是在绑定线程，一般为主线程，注意避免多线程竞争问题
4. 所有逻辑处理应该发生在系统初始化完成之后
5. 本例中是否应该让 redis 连接线程安全，以减少误用造成的影响，毕竟同线程加锁对性能影响很小(否，不开这个口，应该保证正确使用)

---
