---
layout: post
title: "bugs-2020"
date: 2020-01-01
categories: bug
---

---

## 问题:

某模块单元测试 win 下通过，但 linux 下失败

## 原因:

UAF, 使用 pb 定义的数据结构管理状态，又使用 map 保存了 pb 子对象指针，pb 重新生成了子对象，没有更新 map

## 怎么发现的:

运行单元测试，linux 下通过日志一点点缩小范围

## 修复:

pb 重新生成子对象后更新 map 里的指针

## 教训:

1. 一些奇怪的问题很可能是内存问题
2. 直接使用 pb 结构管理状态有时是很方便，但使用子对象指针是要特别注意

---

## 问题:

某伤害排行中，第 1 名伤害量为 0

## 原因:

redis 有序集合的 score 是 double 类型，查询回来的是科学计数法字符串
如 1.3751258853113835e+17，使用转换函数转成整型得到很小的数，导致错误

## 怎么发现的:

测试发现伤害排行中，第 1 名伤害量为 0

## 修复:

使用 atof 转换 score

## 教训:

1. 注意 redis 数据结构与业务数据类型的关系

---

## 问题:

压测过程中服务进程崩溃

## 原因:

多线程修改静态变量、全局配置导致的内存错误

## 怎么发现的:

压测，客户端多的情况服务进程崩溃

## 修复:

修改可能多线各访问的地方，再压测就没出现崩溃的情况

## 教训:

1. 某些奇怪的崩溃问题，看调用栈不像有问题，很可能是因为内存错误造成的
2. 注意某些隐含的修改，map[], std::shuffle 等
3. stl 数据结构都不是线程安全的，只能多线程读，单线程写

---

![宝]({{ site.url }}/imgs/20200704.jpg)
